#!/bin/bash

#
# Copyright (C) 2022 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

set -e

REALM=${REALM:?}
IPADDRESS=${IPADDRESS:?}
HOSTNAME=${HOSTNAME:?}
NBDOMAIN=${NBDOMAIN:?}

cat - > /etc/krb5.conf <<EOF
# generated by $0
[libdefaults]
        default_realm = ${REALM^^}
        dns_lookup_realm = false
        dns_lookup_kdc = true

[realms]
${REALM^^} = {
        default_domain = ${REALM,,}
}

[domain_realm]
        ${REALM,,} = ${REALM^^}
EOF

cat - > /etc/hosts <<EOF
127.0.0.1     localhost.localdomain localhost
${IPADDRESS}     ${HOSTNAME}
EOF

cat - > /etc/resolv.conf <<EOF
search ${REALM,,}
nameserver ${IPADDRESS}
EOF

nbname=$(hostname -s)
mkdir -vp "/var/lib/samba/sysvol/${REALM,,}/scripts"
cat - >/etc/samba/smb.conf <<EOF
# Generated by expand-config. Manual changes to this file are lost!
[global]
        ${PREFIXLEN:+disable netbios = Yes}
        bind interfaces only = Yes
        interfaces = 127.0.0.1 ${IPADDRESS}${PREFIXLEN:+/}${PREFIXLEN}
        netbios name = ${nbname^^}
        realm = ${REALM^^}
        server role = active directory domain controller
        workgroup = ${NBDOMAIN}
        log level = ${SAMBA_LOGLEVEL}
        acl_xattr:security_acl_name = user.NTACL
        include = /etc/samba/include.conf

[sysvol]
        path = /var/lib/samba/sysvol
        read only = No

[netlogon]
        path = /var/lib/samba/sysvol/${REALM,,}/scripts
        read only = No
EOF
